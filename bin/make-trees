#! /bin/bash
# 2020-01-17

SUBTYPES="h1 h3 bv by"
if [[ $# -eq 1 ]]; then
    SUBTYPES="$1"
fi

# ======================================================================

declare -A BASE_SEQS
declare -A SEQDB3_ARGS
declare -A TITLE

# ---------- H1 ----------
BASE_SEQS[h1]="MICHIGAN/45/2015 QMC2MDCK3"
SEQDB3_ARGS[h1]="--flu h1 --recent-matched 3000,4000 --host human --nuc-hamming-distance-threshold 160"
TITLE[h1]="tree H1"

# ---------- H3 ----------
# --> 3a clade is in the middle of the tree, surrounded by 2a subclades
# BASE_SEQS[h3]="SWITZERLAND/8060/2017 SIAT2"
#
# [2020-01-17] trying 3C.3A base seq from the end of 2017
# seqdb3 --flu h3 --whocc-lab --clade 3C.3A --start-date 2017-10-01 --end-date 2018 -p
# A\\(H3N2\\)/ is necessary to avoid selecting AH3N2/ARKANSAS/14/2017_OR
# --> leads to 3a subtree having much shorted edges than 2a subtree
# BASE_SEQS[h3]="A\\(H3N2\\)/KANSAS/14/2017 OR"
#
# [2020-01-24] Derek: the h3 tree should be rooted with an older than 3c.3a and older than 3c.2a strain
# seqdb3 --flu h3 --start-date 2017 --end-date 2017-02 -p --whocc-lab --with-hi-name | grep -v '3C.[123]'
# --> 2a3 clade is above 3a clade and closer to the outgroup
BASE_SEQS[h3]="A\\(H3N2\\)/HAWAII/3/2017"

# [2020-01-27]
# seqdb3 --flu h3 --start-date 2016 --end-date 2016-04 -p --whocc-lab --with-hi-name | grep -v '3C.[123]'
# --> seems to be worse than A/HAWAII/3/2017 case, 2a2 is above 3a
# BASE_SEQS[h3]="A\\(H3N2\\)/NEW YORK/60/2016"

SEQDB3_ARGS[h3]="--flu h3 --recent-matched 3000,4000 --host human --nuc-hamming-distance-threshold 160"
TITLE[h3]="tree H3"

# ---------- BVic ----------
BASE_SEQS[bv]="VICTORIA/830/2013"
SEQDB3_ARGS[bv]="--whocc-lab --flu b --lineage vic --recent 7000 --nuc-hamming-distance-threshold 160"
TITLE[bv]="tree B/Vic"

# ---------- BYam ----------
BASE_SEQS[by]="B/NEW HAMPSHIRE/1/2016 E5"
SEQDB3_ARGS[by]="--flu b --lineage yam --recent-matched 4000,3000 --nuc-hamming-distance-threshold 160"
TITLE[by]="tree B/Yam"

SEQDB3_COMMON_ARGS="--db ../seqdb.json.xz --nucs --wrap --most-common-length --name-format '{seq_id}'"

# ======================================================================

set -x
DATE=$(date +%Y-%m%d)
ROOT_DIR=/syn/eu/ac/results/signature-pages/${DATE}
echo ${ROOT_DIR}
mkdir -p ${ROOT_DIR}
cd ${ROOT_DIR}
cp "${ACMACSD_ROOT}/data/seqdb.json.xz" .

for vir in ${SUBTYPES}; do
    pane=$(tmux new-window -c "${ROOT_DIR}" -n "${TITLE[${vir}]}" -P)
    tmux send-keys -t "${pane}" "mkdir -p ${vir} && cd ${vir} && seqdb3 ${SEQDB3_COMMON_ARGS} ${SEQDB3_ARGS[${vir}]} --base-seq '${BASE_SEQS[${vir}]}' --fasta source.fas && tree-maker init && mg tree-maker.config && echo tree-maker wait" Enter
done
